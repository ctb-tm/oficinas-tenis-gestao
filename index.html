<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Relat√≥rio T√©cnico Mensal ‚Äì Oficinas de T√™nis</title> 
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-2xl p-8 my-10">
    <h1 class="text-3xl font-bold text-center mb-6">Relat√≥rio T√©cnico Mensal ‚Äì Oficinas Educacionais de T√™nis</h1>
    <p class="text-center text-sm mb-8">
      Per√≠odo: 01/10/2025 a 30/10/2025<br> 
      Proponente: <strong>Clube dos Tenistas da Bahia</strong> | CNPJ: 23.146.328/0001-16
    </p>

    <section class="mb-10" id="secFisica">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-2xl font-semibold">1. Execu√ß√£o F√≠sica</h2>
        <button onclick="gerarPDF('secFisica', 'Execu√ß√£o F√≠sica')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">üìÑ Salvar PDF</button>
      </div>
      <table class="w-full text-sm border">
        <thead class="bg-gray-200 text-gray-700">
          <tr>
            <th class="p-2 border">N√∫cleo</th>
            <th class="p-2 border">Atividades Realizadas</th>
            <th class="p-2 border">Meta F√≠sica (%)</th>
            <th class="p-2 border">Execu√ß√£o (%)</th>
            <th class="p-2 border">Observa√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaExecucao"></tbody>
        <tfoot class="bg-gray-50">
          <tr>
            <td colspan="2" class="text-right p-2 font-semibold border">M√©dia de Execu√ß√£o:</td>
            <td colspan="3" class="p-2 border text-center font-semibold" id="mediaFisica">0%</td>
          </tr>
        </tfoot>
      </table>
    </section>

    <section class="mb-10" id="secFinanceira">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-2xl font-semibold">2. Execu√ß√£o Financeira</h2>
        <button onclick="gerarPDF('secFinanceira', 'Execu√ß√£o Financeira')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">üìÑ Salvar PDF</button>
      </div>
      <table class="w-full text-sm border">
        <thead class="bg-gray-200 text-gray-700">
          <tr>
            <th class="p-2 border">Categoria</th>
            <th class="p-2 border">Or√ßado (R$)</th>
            <th class="p-2 border">Executado (R$)</th>
            <th class="p-2 border">Saldo (R$)</th>
            <th class="p-2 border">Execu√ß√£o (%)</th>
          </tr>
        </thead>
        <tbody id="tabelaFinanceira"></tbody>
        <tfoot class="bg-gray-50 font-semibold">
          <tr>
            <td class="p-2 border text-right">Totais:</td>
            <td id="totalOrcado" class="border p-2 text-center">R$ 0,00</td>
            <td id="totalExecutado" class="border p-2 text-center">R$ 0,00</td>
            <td id="totalSaldo" class="border p-2 text-center">R$ 0,00</td>
            <td id="mediaFinanceira" class="border p-2 text-center">0%</td>
          </tr>
        </tfoot>
      </table>
    </section>

    <section class="mb-10" id="secDocs">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-2xl font-semibold">3. Checklist Documental e Observa√ß√µes</h2>
        <button onclick="gerarPDF('secDocs', 'Checklist e Observa√ß√µes')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded text-sm">üìÑ Salvar PDF</button>
      </div>
      <div>
        <h3 class="text-lg font-medium mb-2">Checklist</h3>
        <div id="checklist" class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm mb-6"></div>
        <h3 class="text-lg font-medium mb-2">Observa√ß√µes dos Profissionais</h3>
        <div id="observacoes"></div>
      </div>
    </section>

    <section class="mb-10">
      <h2 class="text-2xl font-semibold mb-3">4. Gr√°fico de Execu√ß√£o F√≠sica x Financeira</h2>
      <canvas id="grafico" height="120"></canvas>
    </section>

    <section>
      <h2 class="text-2xl font-semibold mb-3">5. Assinaturas</h2>
      <div class="grid grid-cols-2 gap-6">
        <div><p>Coordenador T√©cnico ‚Äì <strong>Paulo Santos Carneiro</strong></p><div class="border-t border-gray-600 mt-6"></div></div>
        <div><p>Supervisor de Esportes</p><div class="border-t border-gray-600 mt-6"></div></div>
        <div><p>Professor 1</p><div class="border-t border-gray-600 mt-6"></div></div>
        <div><p>Professor 2</p><div class="border-t border-gray-600 mt-6"></div></div>
        <div class="col-span-2 text-center"><p>Presidente ‚Äì Clube dos Tenistas da Bahia</p><div class="border-t border-gray-600 mt-6 w-1/2 mx-auto"></div></div>
      </div>
    </section>
  </div>

  <script>
    // --- Cria√ß√£o de tabelas e dados ---
    const tabelaExecucao = document.getElementById('tabelaExecucao');
    for (let i = 1; i <= 10; i++) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class='border p-2 text-center font-medium'>N√∫cleo ${i}</td>
        <td class='border p-2'>Oficinas de t√™nis, capacita√ß√£o e acompanhamento</td>
        <td class='border p-2 text-center'>100%</td>
        <td class='border p-2 text-center'><input type='number' min='0' max='100' value='0' class='execFis w-20 border rounded text-center focus:ring focus:ring-blue-200'></td>
        <td class='border p-2'><input type='text' placeholder='Observa√ß√µes...' class='w-full border rounded p-1 focus:ring focus:ring-blue-100'></td>`;
      tabelaExecucao.appendChild(row);
    }

    const categorias = [
      'Materiais esportivos','Uniformes','Equipamentos permanentes','Recursos humanos','Encargos trabalhistas',
      'Alimenta√ß√£o','Transporte','Loca√ß√£o de espa√ßos','Servi√ßos operacionais','Servi√ßos de terceiros','Divulga√ß√£o e promo√ß√£o'
    ];
    const tabelaFinanceira = document.getElementById('tabelaFinanceira');
    categorias.forEach(cat => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class='border p-2'>${cat}</td>
        <td class='border p-2'><input type='number' step='0.01' class='orcado w-28 border rounded text-center' placeholder='0.00'></td>
        <td class='border p-2'><input type='number' step='0.01' class='executado w-28 border rounded text-center' placeholder='0.00'></td>
        <td class='border p-2 saldo text-center'>R$ 0,00</td>
        <td class='border p-2 perc text-center text-gray-600 font-medium'>0%</td>`;
      tabelaFinanceira.appendChild(row);
    });

    // --- Checklist ---
    const checklistItens = ['Notas fiscais originais','Comprovantes banc√°rios','Relat√≥rios fotogr√°ficos','Listas de presen√ßa','Contratos e folhas de pagamento','Execu√ß√£o f√≠sica','Execu√ß√£o financeira','M√≠dias e divulga√ß√£o'];
    const checklist = document.getElementById('checklist');
    checklistItens.forEach(item => {
      const div = document.createElement('div');
      div.innerHTML = `<label class="flex items-center space-x-2"><input type='checkbox' class='accent-blue-500'><span>${item}</span></label>`;
      checklist.appendChild(div);
    });

    // --- Observa√ß√µes ---
    const profissionais = ['Coordenador T√©cnico','Supervisor de Esportes','Professor 1','Professor 2'];
    const obs = document.getElementById('observacoes');
    profissionais.forEach(p => {
      const div = document.createElement('div');
      div.className = 'mb-4';
      div.innerHTML = `<p class='font-medium mb-1'>${p}:</p><textarea class='w-full border rounded p-2 focus:ring focus:ring-blue-100' rows='2' placeholder='Digite observa√ß√µes...'></textarea>`;
      obs.appendChild(div);
    });

    // --- C√°lculos autom√°ticos ---
    function atualizarFinanceiro() {
      let totalOrcado = 0, totalExec = 0;
      document.querySelectorAll('#tabelaFinanceira tr').forEach(tr => {
        const orcado = parseFloat(tr.querySelector('.orcado')?.value || 0);
        const exec = parseFloat(tr.querySelector('.executado')?.value || 0);
        const saldo = orcado - exec;
        const perc = orcado > 0 ? ((exec / orcado) * 100).toFixed(1) : 0; // Uso de orcado > 0 para evitar divis√£o por zero
        
        tr.querySelector('.saldo').innerText = saldo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const percElem = tr.querySelector('.perc');
        percElem.innerText = perc + '%';
        // Atualiza a cor de acordo com o percentual de execu√ß√£o
        percElem.className = 'perc border p-2 text-center font-medium ' + (perc >= 90 ? 'text-green-600' : perc >= 50 ? 'text-yellow-600' : 'text-red-500');
        
        totalOrcado += orcado;
        totalExec += exec;
      });
      
      const totalSaldo = totalOrcado - totalExec;
      const media = totalOrcado > 0 ? ((totalExec / totalOrcado) * 100).toFixed(1) : 0;

      document.getElementById('totalOrcado').innerText = totalOrcado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      document.getElementById('totalExecutado').innerText = totalExec.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      document.getElementById('totalSaldo').innerText = totalSaldo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      document.getElementById('mediaFinanceira').innerText = media + '%';
      
      atualizarGrafico();
    }

    function atualizarFisica() {
      const valores = Array.from(document.querySelectorAll('.execFis')).map(i => parseFloat(i.value || 0));
      // Garante que s√≥ calcula se houver elementos e evita divis√£o por zero.
      const media = valores.length > 0 ? (valores.reduce((a,b)=>a+b)/valores.length).toFixed(1) : 0; 
      
      document.getElementById('mediaFisica').innerText = media + '%';
      
      atualizarGrafico();
    }

    document.addEventListener('input', e => {
      // Verifica se o evento de input pertence a uma das classes de c√°lculo
      if (e.target.classList.contains('orcado') || e.target.classList.contains('executado')) atualizarFinanceiro();
      if (e.target.classList.contains('execFis')) atualizarFisica();
    });

    // Inicializa√ß√£o dos c√°lculos para exibir 0%
    atualizarFisica();
    atualizarFinanceiro();

    // --- Gr√°fico ---
    const ctx = document.getElementById('grafico');
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Execu√ß√£o F√≠sica', 'Execu√ß√£o Financeira'],
        datasets: [{ label: 'Execu√ß√£o (%)', data: [0, 0], backgroundColor: ['#3b82f6', '#22c55e'] }]
      },
      options: { scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
    });
    
    function atualizarGrafico() {
      // CORRE√á√ÉO: L√™ o valor do texto do elemento e converte para float, usando 0 como fallback
      const mediaFisica = parseFloat(document.getElementById('mediaFisica').innerText.replace('%', '')) || 0;
      const mediaFinanceira = parseFloat(document.getElementById('mediaFinanceira').innerText.replace('%', '')) || 0;
      
      chart.data.datasets[0].data = [mediaFisica, mediaFinanceira];
      chart.update();
    }

    // --- Gera√ß√£o de PDF por se√ß√£o ---
    async function gerarPDF(sectionId, titulo) {
      const { jsPDF } = window.jspdf;
      const section = document.getElementById(sectionId);
      
      // Ajuste para evitar que os inputs apare√ßam cortados ou incompletos
      const canvas = await html2canvas(section, { 
          scale: 2,
          logging: false, // Opcional: desativa logs do html2canvas
          useCORS: true 
      });
      
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const imgWidth = pageWidth - 20; // 10mm de margem em cada lado
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      const date = new Date().toLocaleDateString('pt-BR');

      let y = 10;
      pdf.setFontSize(14);
      pdf.text('Relat√≥rio T√©cnico Mensal ‚Äì Oficinas de T√™nis', 10, y);
      y += 6;
      pdf.setFontSize(10);
      pdf.text(`Se√ß√£o: ${titulo}`, 10, y);
      y += 6;
      pdf.text(`Data de emiss√£o: ${date}`, 10, y);
      y += 4; // Espa√ßo antes da imagem

      // Se a imagem for muito longa, ser√° dividida em p√°ginas.
      let position = y;
      pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);

      pdf.save(`${titulo}.pdf`);
    }
  </script>
</body>
</html>
